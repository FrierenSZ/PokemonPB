{% extends 'base.html' %}

{% block body_class %}pokemon-detail-page{% endblock %}

{% block title %}{{ pokemon.name|capitalize }} - Detalhes{% endblock %}

{% macro render_evolution(evo) %}
<div class="evo-stage">
    <div class="evo-card">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/{{ evo.url.split('/')[-2] }}.png"
            alt="{{ evo.name }}" loading="lazy">
        <p><a href="{{ url_for('pokemon_detail', name_or_id=evo.name) }}">{{ evo.name|capitalize }}</a></p>
    </div>
    {% if evo.evolves_to %}
    <span class="evo-arrow">‚Üí</span>
    {% for next_evo in evo.evolves_to %}
    {{ render_evolution(next_evo) }}
    {% endfor %}
    {% endif %}
</div>
{% endmacro %}

{% block content %}
<div class="pokemon-detail-wrapper">
    <div class="pokemon-detail-header" data-type="{{ pokemon.types[0] }}">
        <div class="header-content">
            <a href="{{ url_for('pokedex') }}" class="btn-back-detail">‚Üê Voltar</a>
            <h1 class="pokemon-name">{{ pokemon.name|capitalize }}</h1>
            <span class="pokemon-number">#{{ '%04d'|format(pokemon.id) }}</span>
        </div>
    </div>

    <div class="dashboard-container">
        <aside class="dashboard-sidebar">
            <nav class="sidebar-nav">
                <button class="nav-btn active" data-tab="overview">
                    <span class="nav-icon">üìä</span> <span class="nav-text">Vis√£o Geral</span>
                </button>
                <button class="nav-btn" data-tab="moves" id="btn-load-moves">
                    <span class="nav-icon">‚öîÔ∏è</span> <span class="nav-text">Ataques</span>
                </button>
            </nav>
        </aside>

        <main class="dashboard-content">

            <section id="tab-overview" class="tab-content active">
                <div class="overview-grid">
                    <div class="showcase-area">
                        <div class="pokemon-showcase-large">
                            <img id="main-artwork" src="{{ pokemon.sprites.artwork_default }}" alt="{{ pokemon.name }}">
                            <div class="shiny-wrapper">
                                <label class="shiny-toggle-modern">
                                    <input type="checkbox" id="shiny-toggle" onchange="toggleShiny()">
                                    <span class="slider"></span>
                                    <span class="label-text">Shiny ‚ú®</span>
                                </label>
                            </div>
                        </div>

                        {% if species and species.flavor_text %}
                        <div class="pokemon-description-compact">
                            <p>"{{ species.flavor_text }}"</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="data-area">
                        <div class="info-card">
                            <h3>Dados B√°sicos</h3>
                            <div class="basic-data-grid">
                                <div class="data-row">
                                    <span class="label">Tipo:</span>
                                    <div class="type-list-mini">
                                        {% for type in pokemon.types %}
                                        <span class="type-badge-mini type-{{ type }}">{{ type|capitalize }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="data-row">
                                    <span class="label">Altura:</span>
                                    <span class="val">{{ (pokemon.height / 10)|round(1) }}m</span>
                                </div>
                                <div class="data-row">
                                    <span class="label">Peso:</span>
                                    <span class="val">{{ (pokemon.weight / 10)|round(1) }}kg</span>
                                </div>
                                <div class="data-row">
                                    <span class="label">Habilidades:</span>
                                    <div class="abilities-mini">
                                        {% for ability in abilities %}
                                        <span class="ability-pill" title="{{ ability.description }}">{{
                                            ability.name|replace('-', ' ')|capitalize }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-card stats-card">
                            <h3>Estat√≠sticas Base</h3>
                            <div class="stats-table">
                                <div class="stat-row header">
                                    <span class="col-stat">Status</span>
                                    <span class="col-val">Base</span>
                                    <span class="col-bar"></span>
                                    <span class="col-min">Min</span>
                                    <span class="col-max">Max</span>
                                </div>

                                {% for stat, item in pokemon.stats_ranges.items() %}
                                <div class="stat-row">
                                    <span class="col-stat label">{{ stat|replace('-', ' ')|replace('special',
                                        'sp.')|title }}</span>
                                    <span class="col-val">{{ item.base }}</span>

                                    <div class="col-bar">
                                        <div class="stat-bar-track-new">
                                            <div class="stat-bar" data-value="{{ item.base }}"
                                                data-color="{{ item.color }}" style="width: 0%;">
                                            </div>
                                        </div>
                                    </div>

                                    <span class="col-min">{{ item.min }}</span>
                                    <span class="col-max">{{ item.max }}</span>
                                </div>
                                {% endfor %}

                                <div class="stat-row total">
                                    <span class="col-stat label">Total</span>
                                    <span class="col-val">{{ pokemon.stats.values()|sum }}</span>
                                    <span class="col-bar"></span>
                                    <span class="col-min">Min</span>
                                    <span class="col-max">Max</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="evolution-wrapper-overview" style="margin-top: 40px;">
                    {% if evolution_chain %}
                    <div class="evolution-container">
                        <h3>Linha Evolutiva</h3>
                        <div class="evolution-chain-new">
                            {{ render_evolution(evolution_chain) }}
                        </div>
                    </div>
                    {% endif %}

                    {% if varieties and varieties|length > 0 %}
                    <div class="varieties-container" style="margin-top: 40px;">
                        <h3>Mega Evolu√ß√µes & Formas Alternativas</h3>
                        <div class="varieties-grid">
                            {% for form in varieties %}
                            
                            {% set form_name_clean = form.name|replace(pokemon.name, '')|replace('-', ' ')|trim|capitalize %}
                            {% set form_image = form.sprites.artwork_default or form.sprites.front_default %}

                            <a href="{{ url_for('pokemon_detail', name_or_id=form.name) }}" class="variety-card">
                                <div class="variety-image-wrapper">
                                    <img src="{{ form_image }}" alt="{{ form.name }}" loading="lazy">
                                </div>
                                <p class="variety-name">{{ form_name_clean }}</p>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% elif species.varieties and species.varieties|length > 0 %}
                    <div class="varieties-container" style="margin-top: 40px;">
                        <h3>Formas Alternativas</h3>
                        <div class="varieties-grid">
                            {% for variety in species.varieties %}
                                {% if not variety.is_default %}
                                <div class="variety-card simple">
                                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/{{ variety.pokemon.url.split('/')[-2] }}.png"
                                         alt="{{ variety.pokemon.name }}" loading="lazy">
                                    <p>{{ variety.pokemon.name|replace(pokemon.name, '')|replace('-', ' ')|trim|capitalize }}</p>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </section>

            <section id="tab-moves" class="tab-content">
                <div class="moves-header">
                    <h3>Ataques Dispon√≠veis <span class="badge-count">{{ pokemon.moves|length }}</span></h3>
                    <div class="moves-search-wrapper">
                        <input type="text" id="move-search" placeholder="üîç Buscar ataque..." autocomplete="off">
                    </div>
                </div>

                <div id="moves-loader" style="display: none; text-align: center; padding: 20px;">
                    <p>Carregando ataques...</p>
                </div>

                <div class="moves-grid" id="moves-container">
                    </div>
            </section>

        </main>
    </div>
</div>

<style>
/* CSS styles for varieties grid (mantido) */
.varieties-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.variety-card {
    background: #2a2a2a;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: transform 0.2s, background 0.2s;
    text-decoration: none;
    color: inherit;
    border: 1px solid #333;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.variety-card:hover {
    transform: translateY(-5px);
    background: #333;
    border-color: #555;
}

.variety-image-wrapper {
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.variety-image-wrapper img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.variety-name {
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: #eee;
}


/* Fallback styles */
.variety-card.simple img {
    width: 80px;
    height: 80px;
}
</style>

<script>
    // === SWAP DE ABAS ===
    const navBtns = document.querySelectorAll('.nav-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            navBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(t => t.classList.remove('active'));

            btn.classList.add('active');
            const tabId = btn.dataset.tab;
            document.getElementById(`tab-${tabId}`).classList.add('active');

            if (tabId === 'moves' && !movesLoaded) {
                loadMoves();
            }
        });
    });

    // === SHINY TOGGLE ===
    const sprites = {
        default: { artwork: "{{ pokemon.sprites.artwork_default }}" },
        shiny: { artwork: "{{ pokemon.sprites.artwork_shiny }}" }
    };

    function toggleShiny() {
        const isShiny = document.getElementById('shiny-toggle').checked;
        const artwork = isShiny ? sprites.shiny.artwork : sprites.default.artwork;
        document.getElementById('main-artwork').src = artwork;
    }

    // === MOVES SYSTEM ===
    const movesData = JSON.parse('{{ pokemon.moves | tojson | safe }}');
    let movesLoaded = false;
    const movesContainer = document.getElementById('moves-container');
    const moveSearch = document.getElementById('move-search');

    const moveCache = {};
    const moveTypeCache = {};

    try {
        const sm = localStorage.getItem('moveCache');
        const st = localStorage.getItem('moveTypeCache');
        if (sm) Object.assign(moveCache, JSON.parse(sm));
        if (st) Object.assign(moveTypeCache, JSON.parse(st));
    } catch (e) { console.error(e); }

    function saveCache() {
        try {
            localStorage.setItem('moveCache', JSON.stringify(moveCache));
            localStorage.setItem('moveTypeCache', JSON.stringify(moveTypeCache));
        } catch (e) { }
    }

    function loadMoves() {
        if (movesLoaded) return;

        const loader = document.getElementById('moves-loader');
        loader.style.display = 'block';

        setTimeout(() => {
            movesContainer.innerHTML = movesData.map(move => {
                const displayName = move.name.replace(/-/g, ' ');
                return `
                    <div class="move-card" id="card-${move.name}" data-move-name="${move.name}" data-move-display="${displayName}">
                        <div class="move-name">${displayName}</div>
                        <span class="move-type-name">...</span>
                        <div class="move-tooltip" id="tooltip-${move.name}">
                            <div class="loading">Carregando detalhes...</div> 
                        </div>
                    </div>
                `;
            }).join('');

            setupMoveHoverEvents();
            loader.style.display = 'none';
            movesLoaded = true;
            fetchMovesInBatches(0);
        }, 50);
    }

    const BATCH_SIZE = 10;

    async function fetchMovesInBatches(startIndex) {
        if (startIndex >= movesData.length) return;
        const batch = movesData.slice(startIndex, startIndex + BATCH_SIZE);
        const promises = batch.map(move => fetchMoveDetails(move.name));
        await Promise.allSettled(promises);
        setTimeout(() => {
            fetchMovesInBatches(startIndex + BATCH_SIZE);
        }, 200);
    }

    async function fetchMoveDetails(moveName) {
        if (moveCache[moveName]) {
            updateCardUI(moveName, moveCache[moveName], moveTypeCache[moveName]);
            return;
        }

        try {
            const res = await fetch(`/api/move/${moveName}`);
            const data = await res.json();
            if (data.error) return;

            const html = `
                <div class="tooltip-header">
                    <span class="type-badge type-${data.type}">${data.type}</span>
                    <span class="damage-class">${data.damage_class}</span>
                </div>
                <div class="tooltip-stats">
                    <span><strong>PWR:</strong> ${data.power || '-'}</span>
                    <span><strong>ACC:</strong> ${data.accuracy || '-'}%</span>
                    <span><strong>PP:</strong> ${data.pp}</span>
                </div>
                <div class="tooltip-effect">${data.effect}</div>
            `;

            moveCache[moveName] = html;
            moveTypeCache[moveName] = data.type;
            saveCache();
            updateCardUI(moveName, html, data.type);
        } catch (e) {
            console.error(`Erro ao carregar move ${moveName}`, e);
        }
    }

    const typeColors = {
        'normal': '#A8A77A', 'fire': '#EE8130', 'water': '#6390F0', 'electric': '#F7D02C',
        'grass': '#7AC74C', 'ice': '#96D9D6', 'fighting': '#C22E28', 'poison': '#A33EA1',
        'ground': '#E2BF65', 'flying': '#A98FF3', 'psychic': '#F95587', 'bug': '#A6B91A',
        'rock': '#B6A136', 'ghost': '#735797', 'dragon': '#6F35FC', 'dark': '#705746',
        'steel': '#B7B7CE', 'fairy': '#D685AD'
    };

    function updateCardUI(moveName, tooltipHtml, type) {
        const card = document.getElementById(`card-${moveName}`);
        if (!card) return;

        if (type) {
            const col = typeColors[type] || '#777';
            card.style.background = `linear-gradient(135deg, ${col} 0%, ${col}CC 100%)`;
            card.style.borderColor = col;
            const span = card.querySelector('.move-type-name');
            if (span) span.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        }

        const tooltip = document.getElementById(`tooltip-${moveName}`);
        if (tooltip) {
            tooltip.innerHTML = tooltipHtml;
            tooltip.classList.add('loaded');
        }
    }

    function setupMoveHoverEvents() {
        movesContainer.addEventListener('mouseover', (e) => {
            const card = e.target.closest('.move-card');
            if (!card) return;
            const tooltip = card.querySelector('.move-tooltip');
            if (tooltip) tooltip.classList.add('active');
        });

        movesContainer.addEventListener('mouseout', (e) => {
            const card = e.target.closest('.move-card');
            if (!card) return;
            const tooltip = card.querySelector('.move-tooltip');
            if (tooltip) tooltip.classList.remove('active');
        });
    }

    moveSearch.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.move-card');
        cards.forEach(card => {
            const name = card.dataset.moveDisplay.toLowerCase();
            card.style.display = name.includes(term) ? '' : 'none';
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.stat-bar').forEach(bar => {
            const val = parseInt(bar.dataset.value);
            const color = bar.dataset.color || '#ccc';
            bar.style.setProperty('background-color', color, 'important');
            bar.style.boxShadow = `0 0 8px ${color}40`;
            setTimeout(() => {
                bar.style.width = Math.min((val / 255) * 100, 100) + '%';
            }, 100);
        });

        const header = document.querySelector('.pokemon-detail-header');
        if (header) header.classList.add('type-' + header.dataset.type);
    });
</script>
{% endblock %}